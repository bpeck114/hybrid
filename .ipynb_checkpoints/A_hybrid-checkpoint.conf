#FILE kscao_lgs.conf
# Keck SCAO LGS circa 2023 (pre-KAPA)

__reset__         		#replace all previous entries.
__default__	      		#this file contains default setup.

#add the directory to search path for files. Relative to $MAOS_CONFIG
path = "bin"
path = "atm"

#defines simulation parameters.
include     	= "keck_sim.conf"

#AO type. 
include     	= "keck_dm_single.conf" 

#Atmospheric profile
include     	= "atm_mk13n50p_ground_detail.conf" #Mauna Kea 13N, Chun MK_OTP 'binned' model

#Wavefront sensor information. 
include     	= "keck_wfs_hybrid_strap_lbwfs.conf"

#Including configurations for reconstruction (tomo/fitting)
include     	= "recon.conf"

#For debugging purpose
include     	= "dbg.conf"

#For DM fitting
include		    = "keck_fit.conf"

#### BASE OVERRIDES

# Set observation location on sky
sim.zadeg     = 30    #zenith angle. moved from atm.zadeg

evl.thetax  	= [0]
evl.thetay  	= [0]
evl.fov		= 1	# this value in arcsec will scale the evl points

evl.psf		= [1]
evl.wt		= [1]

# reconstruction aglorithms choices, some outputs, and the simulation resolution.
recon.alg	= 0 #scao mvr works better than lsr; 0 = min var, 1 = least squares

evl.dx		= 1/32 #1/32 is needed to have enough size for short wavelength

# Manual Gain (Commented out to just let MAOS do its thing for now)
#recon.psd = 0 # Turn off MAOS guessing gain
#sim.ephi = 0.4 # Setting both hi and low order gain (should be around 0.3-0.5)

# HYBRID OVERRIDES
tomo.precond = 0 # Needed for hybrid (maybe also #powfs.pywfs = [])
powfs.hs = [90e3 30.11e3 inf inf] # 30km default for Rayleigh, otherwise through command line

powfs.nwfs = [1 1 1 1] # Sodium, Rayleigh, Tip-Tilt, Truth
wfs.thetax = [0 0 0 0] 
wfs.thetay = [0 0 0 0]

powfs0_llt.ox = [0] *6.5 # Sodium
powfs0_llt.oy = [0] *6.5
powfs0_llt.fnprof = "NapMean.bin"

powfs1_llt.ox = [0] *6.5 # Rayleigh
powfs1_llt.oy = [0] *6.5
powfs1_llt.fnprof = "NapDelta30.fits" # Needs to be adjusted for different altitudes

powfs.dsa = [0 0 -1 0]
powfs.phystep = [-1 -1 -1 -1] # Setting to [-1 -1 -1 -1] could reduce memory

atm.dx = 1/128 # Needs to match powfs.dx (might be needed for more actuators)
powfs.dx = [1/128 1/128 1/16 1/32]
evl.dx = 1/128 
sim.alhi = 0 #0.322 (original value), no latency

# MORE ACTUATORS ON DM
dm.dx = [0.287] # 34x34 or 1156 actuators
dm.stroke = [300.0] # ASM stroke for VisMCAO x10
dm.iastroke = [20.0] # ASM ia-stroke for VisMCAO x10

# FASTER
sim.dt = 1/1500
sim.dtref = 1/1500
sim.end = 1000 # Longer (2 sec)

# PSF Evaluation
evl.thetax = [0 5 10 15 20 25 30 35 45 60]
evl.thetay = [0 0 0 0 0 0 0 0 0 0]

# More Wavelengths
evl.psfsize = [128 128 128 128 128 128 128 128 128]
evl.wvl = [0.432e-6 0.544e-6 0.652e-6 0.810e-6 0.877e-6 1.020e-6 1.248e-6 1.673e-6 2.200e-6]

# Reconstruction
recon.psd = 1 # compute PDDs of DM error signal (0: turn off MAOS guessing gain)
sim.ephi = 0.4 # Setting both hi and low order gain (should be around 0.3-0.5)

# DM Fitting
#evl.tomo = 1 # Turns off dm fitting
#gpu.evl = 0 # Needed for evl.tomo = 1
#recon.split = 0 # Needed for evl.tomo = 1
fit.fov = 30 # Setting field of view
#sim.closeloop = 0 # Turning on open loop